<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Dining Room</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
body { font-family: sans-serif; background: radial-gradient(circle at top left, #1a1a1a, #0e0e0e); color: white; overflow: hidden; }
.menu-card { background: rgba(255,255,255,0.05); border-radius: 12px; padding: 10px; height: 260px; display:flex; flex-direction:column; justify-content:space-between; }
.menu-card:focus { outline: 3px solid #facc15; transform: scale(1.05); background: rgba(255,255,255,0.15); }
.qty-btn { width: 30px; height: 30px; border-radius: 50%; background: #333; border: 1px solid #555; }
.qty-btn:focus, .qty-btn:hover { background: #facc15; color: black; }
</style>
</head>
<body>
<div class="flex h-screen w-screen">
  <div class="flex-1 p-8 overflow-auto">
    <h1 class="text-4xl font-bold text-yellow-400 mb-6 text-center" data-translate="dining_title">Dining Room</h1>
    <div id="menu-list" class="grid grid-cols-3 gap-6"></div>
  </div>
  <div class="w-96 bg-gray-900 p-6 flex flex-col border-l border-gray-700">
    <h2 class="text-xl font-bold mb-4 text-yellow-400" data-translate="cart">Keranjang</h2>
    <div id="cart-list" class="flex-1 overflow-auto space-y-3"></div>
    <div class="border-t border-gray-700 pt-4 mt-2">
      <div class="flex justify-between font-bold mb-4">
        <span data-translate="total">Total:</span> <span id="cart-total" class="text-yellow-400">0</span>
      </div>
      <button id="submit-btn" class="w-full bg-yellow-400 text-black py-3 rounded-lg font-bold hover:bg-yellow-300" data-translate="order_btn">Pesan</button>
      <button id="close-btn" class="w-full bg-gray-700 mt-3 py-3 rounded-lg hover:bg-gray-600" data-translate="close">Tutup</button>
    </div>
  </div>
</div>
<script>
let cart={};
const lang = localStorage.getItem('app_lang') || 'id';
const dict = {
  'id': { 'dining_title': 'Dining Room', 'cart': 'Keranjang', 'total': 'Total', 'order_btn': 'Pesan', 'close': 'Tutup', 'success': 'Berhasil', 'empty': 'Kosong' },
  'en': { 'dining_title': 'Dining Room', 'cart': 'Cart', 'total': 'Total', 'order_btn': 'Order', 'close': 'Close', 'success': 'Success', 'empty': 'Empty' }
};

document.querySelectorAll('[data-translate]').forEach(el => {
  const k = el.dataset.translate;
  if(dict[lang][k]) el.textContent = dict[lang][k];
});

async function load() {
  try {
      const res = await fetch(`./api.php?action=getDining&lang=${lang}`);
      const d = await res.json();
      const c = document.getElementById('menu-list');
      d.data.forEach((i, idx) => {
        const el = document.createElement('div');
        el.className='menu-card';
        el.tabIndex=0; 
        el.dataset.index=idx;
        el.innerHTML=`
            <div>
                <img src="${i.icon_path}" class="h-32 w-full object-cover rounded mb-3">
                <b class="text-yellow-400 text-lg block leading-tight">${i.name}</b>
            </div>
            <p class="text-gray-300 mt-2">Rp ${parseInt(i.price).toLocaleString()}</p>
        `;
        el.onclick=()=>add(i);
        el.onkeydown=(e)=>{if(e.key==='Enter')add(i)};
        c.appendChild(el);
      });
      c.firstElementChild?.focus();
  } catch(e){ document.getElementById('menu-list').innerHTML = '<p class="text-red-500 text-center col-span-3">Failed to load menu</p>'; }
}

function add(i) {
  if(!cart[i.id]) cart[i.id]={...i, qty:0};
  cart[i.id].qty++; render();
}

function render() {
  const c = document.getElementById('cart-list'); c.innerHTML='';
  let t=0;
  for(let k in cart) {
    const i=cart[k]; t+=i.price*i.qty;
    const div = document.createElement('div');
    div.className = "flex justify-between items-center bg-gray-800 p-3 rounded";
    div.innerHTML = `
        <div class="flex flex-col"><span class="font-bold text-sm">${i.name}</span><span class="text-xs text-gray-400">Rp ${i.price.toLocaleString()}</span></div>
        <div class="flex items-center gap-2">
            <button class="qty-btn" onclick="updateQty(${i.id}, -1)">-</button>
            <span class="w-4 text-center">${i.qty}</span>
            <button class="qty-btn" onclick="updateQty(${i.id}, 1)">+</button>
        </div>
    `;
    c.appendChild(div);
  }
  document.getElementById('cart-total').textContent = 'Rp '+t.toLocaleString();
}

window.updateQty = (id, delta) => {
    if(cart[id]) {
        cart[id].qty += delta;
        if(cart[id].qty <= 0) delete cart[id];
        render();
    }
};

document.getElementById('submit-btn').onclick=async()=>{
  if(Object.keys(cart).length===0) return alert(dict[lang]['empty']);
  await fetch('./api.php?action=submitDiningOrder', {
    method:'POST', body:JSON.stringify({guest_name:localStorage.getItem('guest_name_v8_final')||'Guest', room_number:localStorage.getItem('room_number_v8_final')||'-', items:Object.values(cart)})
  });
  alert(dict[lang]['success']); cart={}; render();
};

document.getElementById('close-btn').onclick=()=>location.href='index.php';

// Navigasi Keyboard Sederhana
document.addEventListener('keydown', (e) => {
    if(e.key === 'Backspace' || e.key === 'Escape') location.href='index.php';
    
    // Pindah ke Cart dengan ArrowRight dari kolom paling kanan
    if(e.key === 'ArrowRight' && document.activeElement.classList.contains('menu-card')) {
        const idx = parseInt(document.activeElement.dataset.index);
        if((idx+1) % 3 === 0) { // Kolom ke-3
            document.getElementById('close-btn').focus();
            e.preventDefault();
        }
    }
    // Pindah kembali ke Menu
    if(e.key === 'ArrowLeft' && !document.activeElement.classList.contains('menu-card')) {
        document.querySelector('.menu-card')?.focus();
        e.preventDefault();
    }
});

load();
</script>
</body>
</html>